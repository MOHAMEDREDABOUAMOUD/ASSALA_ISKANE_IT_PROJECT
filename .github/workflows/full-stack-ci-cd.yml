name: Full Stack CI/CD

on:
  push:
    branches: [ main, reda ]
  pull_request:
    branches: [ main, reda ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: reda
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Wait for MySQL to be ready and create schema
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in {30..0}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -preda --silent; then
              break
            fi
            echo "MySQL is unavailable - sleeping"
            sleep 1
          done

          echo "Creating database schema..."
          mysql -h 127.0.0.1 -uroot -preda -e "create database assalaIskane;
                                              use assalaIskane;
                                              create table user(id varchar(10) primary key, nom varchar(30), prenom varchar(30), fonction varchar(30), numero varchar(15), pass varchar(30));
                                              create table projet(id varchar(100) primary key, nom varchar(100), numero_marche varchar(50), objet varchar(400), date_ordre date, date_fin date, delai int, id_resp varchar(10));
                                              alter table projet add constraint foreign key (id_resp) references user(id);
                                              create table ouvrier(id varchar(15) primary key, id_projet varchar(40), nom varchar(20), prenom varchar(20), numero varchar(15));
                                              alter table ouvrier add constraint foreign key (id_projet) references projet(id);
                                              create table chantier(id int primary key auto_increment, id_projet varchar(100), id_resp varchar(10));
                                              alter table chantier add constraint foreign key (id_projet) references projet(id);
                                              alter table chantier add constraint foreign key (id_resp) references user(id);
                                              create table besoin(id int primary key auto_increment, nom varchar(50), date_demande date, qte int, valide_par varchar(10), id_chantier int);
                                              alter table besoin add constraint foreign key (id_chantier) references chantier(id);
                                              alter table besoin add constraint foreign key (valide_par) references user(id);
                                              create table fichier_projet(id int primary key auto_increment, nom varchar(100), fichier longblob, id_projet varchar(100));
                                              alter table fichier_projet add constraint foreign key (id_projet) references projet(id);
                                              create table absence(id int primary key auto_increment, id_ouvrier varchar(10), date_absence date, id_chantier int, absent int, valide_par varchar(10));
                                              alter table absence add constraint foreign key (valide_par) references user(id);
                                              alter table absence add constraint foreign key (id_ouvrier) references ouvrier(id);
                                              alter table absence add constraint foreign key (id_chantier) references chantier(id);
                                              create table stock(id int primary key auto_increment, gerant varchar(50), numero varchar(15), email varchar(30));
                                              create table materiel(id int primary key auto_increment, nom varchar(20), qte int, prix float, id_stock int);
                                              alter table materiel add constraint foreign key (id_stock) references stock(id);
                                              create table materiel_chantier(id int primary key auto_increment, id_materiel int, id_chantier int, qte int, date_entre date);
                                              alter table materiel_chantier add constraint foreign key (id_materiel) references materiel(id);
                                              alter table materiel_chantier add constraint foreign key (id_chantier) references chantier(id);
                                              create table materiaux(id int primary key auto_increment, nom varchar(50), type varchar(20), qte int, prix float, id_stock int);
                                              alter table materiaux add constraint foreign key (id_stock) references stock(id);
                                              create table materiaux_chantier(id int primary key auto_increment, id_materiaux int, id_chantier int, qte int, date_entre date);
                                              alter table materiaux_chantier add constraint foreign key (id_materiaux) references materiaux(id);
                                              alter table materiaux_chantier add constraint foreign key (id_chantier) references chantier(id);
                                              create table rapport_jour(id int primary key, date_rj date, temperature varchar(50), pluie varchar(50), vent varchar(50), remarque varchar(150), id_chantier int);
                                              alter table rapport_jour add constraint foreign key (id_chantier) references chantier(id);
                                              create table rj_perso_travaille(id int primary key auto_increment, id_rj int, type varchar(30), id_ouvrier varchar(15));
                                              alter table rj_perso_travaille add constraint foreign key (id_ouvrier) references ouvrier(id);
                                              alter table rj_perso_travaille add constraint foreign key (id_rj) references rapport_jour(id);
                                              create table rj_materiel_sur_chantier(id int primary key auto_increment, materiel varchar(50), qte int, etat varchar(30), type varchar(30), id_rj int);
                                              alter table rj_materiel_sur_chantier add constraint foreign key (id_rj) references rapport_jour(id);
                                              create table rj_travaux_realiser(id int primary key auto_increment, id_rj int, description varchar(150));
                                              alter table rj_travaux_realiser add constraint foreign key (id_rj) references rapport_jour(id);
                                              create table photo_rjtr(id int primary key auto_increment, id_rj_tr int, photo longblob);
                                              alter table photo_rjtr add constraint foreign key (id_rj_tr) references rj_travaux_realiser(id);
                                              create table rj_materiels_materiaux(id int primary key auto_increment, id_rj int, designation varchar(50), unite varchar(1), qte int);
                                              alter table rj_materiels_materiaux add constraint foreign key (id_rj) references rapport_jour(id);
                                              create table avancement_projet(id int primary key auto_increment, date_rapport date, id_projet varchar(40));
                                              alter table avancement_projet add constraint foreign key (id_projet) references projet(id);
                                              create table ap(id int primary key auto_increment, id_ap int, no int, nom varchar(50), duree int, debut date, fin date, etat varchar(30), avancement varchar(100));
                                              -- Fill 'user' table with all roles
                                              INSERT INTO user (id, nom, prenom, fonction, numero, pass) VALUES
                                              ('U001', 'Smith', 'John', 'ChefChantier', '1234567890', 'pass123'),
                                              ('U002', 'Doe', 'Jane', 'responsable_comptabiliter', '0987654321', 'pass456'),
                                              ('U003', 'Brown', 'Michael', 'responsable_marchandise', '1122334455', 'pass789'),
                                              ('U004', 'Taylor', 'Alice', 'responsable_projet', '2233445566', 'pass321'),
                                              ('U005', 'Johnson', 'Emily', 'responsable_technique', '3344556677', 'pass654'),
                                              ('U006', 'Davis', 'David', 'service_technique', '4455667788', 'pass987');

                                              -- Fill 'projet' table, associating each project with a responsible user
                                              INSERT INTO projet (id, nom, numero_marche, objet, date_ordre, date_fin, delai, id_resp) VALUES
                                              ('P001', 'Project A', 'M001', 'Building a bridge', '2023-01-15', '2023-12-15', 330, 'U001'),
                                              ('P002', 'Project B', 'M002', 'Construction of a road', '2023-03-01', '2023-09-01', 184, 'U004');

                                              -- Fill 'chantier' table, associating each chantier with the relevant 'ChefChantier'
                                              INSERT INTO chantier (id_projet, id_resp) VALUES
                                              ('P001', 'U001'),
                                              ('P002', 'U004');

                                              -- Fill 'ouvrier' table with associations to projects
                                              INSERT INTO ouvrier (id, id_projet, nom, prenom, numero) VALUES
                                              ('O001', 'P001', 'Williams', 'David', '1112223334'),
                                              ('O002', 'P002', 'Johnson', 'Chris', '5556667778');

                                              -- Fill 'besoin' table with requests for each chantier, validated by relevant users
                                              INSERT INTO besoin (nom, date_demande, qte, valide_par, id_chantier) VALUES
                                              ('Cement', '2023-05-01', 50, 'U001', 1),
                                              ('Steel', '2023-05-05', 30, 'U004', 2);

                                              -- Fill 'fichier_projet' table with project files
                                              INSERT INTO fichier_projet (nom, fichier, id_projet) VALUES
                                              ('Blueprint A', '0xFFD8FFE0', 'P001'),
                                              ('Blueprint B', '0xFFD8FFE1', 'P002');

                                              -- Fill 'absence' table for workers associated with projects
                                              INSERT INTO absence (id_ouvrier, date_absence, id_chantier, absent) VALUES
                                              ('O001', '2023-06-10', 1, 1),
                                              ('O002', '2023-06-12', 2, 1);

                                              -- Fill 'stock' table with different stock entries
                                              INSERT INTO stock (gerant, numero, email) VALUES
                                              ('John Doe', '1234567890', 'johndoe@example.com'),
                                              ('Jane Smith', '0987654321', 'janesmith@example.com');

                                              -- Fill 'materiel' table with materials linked to stock
                                              INSERT INTO materiel (nom, qte, prix, id_stock) VALUES
                                              ('Excavator', 2, 25000.00, 1),
                                              ('Crane', 1, 45000.00, 2);

                                              -- Fill 'materiel_chantier' table to link materials with chantiers
                                              INSERT INTO materiel_chantier (id_materiel, id_chantier, qte) VALUES
                                              (1, 1, 1),
                                              (2, 2, 1);

                                              -- Fill 'materiaux' table with different material types in stock
                                              INSERT INTO materiaux (nom, type, qte, prix, id_stock) VALUES
                                              ('Cement', 'Building', 100, 1000.00, 1),
                                              ('Steel', 'Reinforcement', 50, 5000.00, 2);

                                              -- Fill 'materiaux_chantier' table linking materials to chantiers
                                              INSERT INTO materiaux_chantier (id_materiaux, id_chantier, qte) VALUES
                                              (1, 1, 50),
                                              (2, 2, 25);

                                              -- Fill 'rapport_jour' table with daily reports per chantier
                                              INSERT INTO rapport_jour (id, date_rj, temperature, pluie, vent, remarque, id_chantier) VALUES
                                              (1, '2023-07-01', '30Â°C', 'No', 'Mild', 'Work progressing well', 1),
                                              (2, '2023-07-02', '28Â°C', 'Yes', 'Strong', 'Delayed due to rain', 2);

                                              -- Fill 'rj_perso_travaille' table with personnel associated with daily reports
                                              INSERT INTO rj_perso_travaille (id_rj, type, id_ouvrier) VALUES
                                              (1, 'Labor', 'O001'),
                                              (2, 'Foreman', 'O002');

                                              -- Fill 'rj_materiel_sur_chantier' table with material conditions per daily report
                                              INSERT INTO rj_materiel_sur_chantier (materiel, qte, etat, type, id_rj) VALUES
                                              ('Excavator', 1, 'Good', 'Heavy', 1),
                                              ('Crane', 1, 'Average', 'Heavy', 2);

                                              -- Fill 'rj_travaux_realiser' table with work descriptions per report
                                              INSERT INTO rj_travaux_realiser (id_rj, description) VALUES
                                              (1, 'Foundation work completed'),
                                              (2, 'Steel framework erected');

                                              -- Fill 'photo_rjtr' table with photos of work done per report
                                              INSERT INTO photo_rjtr (id_rj_tr, photo) VALUES
                                              (1, '0xFFD8FFE2'),
                                              (2, '0xFFD8FFE3');

                                              -- Fill 'rj_materiels_materiaux' table with materials used per daily report
                                              INSERT INTO rj_materiels_materiaux (id_rj, designation, unite, qte) VALUES
                                              (1, 'Cement', 'T', 20),
                                              (2, 'Steel', 'T', 15);

                                              -- Fill 'avancement_projet' table to report project progress
                                              INSERT INTO avancement_projet (date_rapport, id_projet) VALUES
                                              ('2023-08-01', 'P001'),
                                              ('2023-08-15', 'P002');

                                              -- Fill 'ap' table with project tasks
                                              INSERT INTO ap (id_ap, no, nom, duree, debut, fin, etat, avancement) VALUES
                                              (1, 1, 'Task A', 10, '2023-07-01', '2023-07-11', 'Completed', '100%'),
                                              (2, 2, 'Task B', 15, '2023-07-12', '2023-07-27', 'In Progress', '60%');"


      # ðŸ“¦ FRONTEND: Install and build React
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies (React)
        working-directory: FrontEnd/front_v2
        run: npm install

      - name: Build React app
        working-directory: FrontEnd/front_v2
        run: CI=false npm run build

      # â˜• BACKEND: Build Spring Boot project with Maven
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven
        working-directory: BackEnd/ASSALA_ISKANE_SpringBoot_BackEnd
        run: mvn clean install

  # Optional: Dockerize and deploy (CD)
  dockerize:
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker images with docker-compose
        run: docker compose build

      - name: Push Docker images to DockerHub
        run: docker compose push

